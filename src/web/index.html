<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Loading...</title>
    <link rel="icon" href="data:,">
</head>
<body>
<script>
async function loadWasm() {
    let wasmExports;
    let elements = [null, document.body];
    let threads = [];
    let wasmModule;

    const getString = (ptr, len) => new TextDecoder().decode(new Uint8Array(wasmExports.memory.buffer, ptr, len));
    
    const threadTask = function() {
        let wasmInstance;
        
        const getString = (ptr, len) => new TextDecoder().decode(new Uint8Array(wasmInstance.exports.memory.buffer, ptr, len));
        
        const log = (fn, msgPtr, msgLen, stylePtr, styleLen) => {
            const msg = getString(msgPtr, msgLen);
            const style = getString(stylePtr, styleLen);
            fn('%c' + msg, style);
        };
        
        onmessage = async function(e) {
            if (e.data.type === 'init') {
                const module = e.data.module;
                
                // Minimal thread imports
                const threadImportObject = {
                    env: {
                        dom_op: () => 0, // Threads cant do DOM ops
                        wasm_log: (p,l,s,sl) => log(console.log, p,l,s,sl),
                        wasm_warn: (p,l,s,sl) => log(console.warn, p,l,s,sl),
                        wasm_err: (p,l,s,sl) => log(console.error, p,l,s,sl),
                    }
                };
                
                wasmInstance = await WebAssembly.instantiate(module, threadImportObject);
            } else if (e.data.type === 'run') {
                try {
                    wasmInstance.exports.invoke_thread_task(e.data.task_id);
                } catch (error) {
                    console.error('Error calling invoke_thread_task:', error);
                }
            }
        };
    };
    
    // Single DOM operation dispatcher
    const dom_op = (op, id, ptr1, len1, ptr2, len2) => {
        const s1 = len1 ? getString(ptr1, len1) : null;
        const s2 = len2 ? getString(ptr2, len2) : null;
        
        switch(op) {
            case 0: // createElement
                const el = document.createElement(s1);
                elements.push(el);
                return elements.length - 1;
                
            case 1: // appendChild  
                if (elements[id] && elements[ptr1])
                    elements[id].appendChild(elements[ptr1]);
                return 0;
                
            case 2: // setAttribute
                if (elements[id]) elements[id].setAttribute(s1, s2);
                return 0;
                
            case 3: // addEventListener
                if (elements[id]) {
                    elements[id].addEventListener(s1, () => wasmExports.invoke(ptr2));
                }
                return 0;
                
            case 4: // getValue
                if (elements[id] && elements[id].value) {
                    const value = elements[id].value;
                    const bytes = new TextEncoder().encode(value);
                    const copyLen = Math.min(bytes.length, len2);
                    new Uint8Array(wasmExports.memory.buffer).set(bytes.slice(0, copyLen), ptr2);
                    return copyLen;
                }
                return 0;
                
            case 5: // setInnerHTML
                if (elements[id]) elements[id].innerHTML = s1;
                return 0;
                
            case 6: // setTextContent
                if (elements[id]) elements[id].textContent = s1;
                return 0;
                
            case 7: // setClassName
                if (elements[id]) elements[id].className = s1;
                return 0;
                
            case 8: // setId
                if (elements[id]) elements[id].id = s1;
                return 0;
                
            case 9: // setTitle
                document.title = s1;
                return 0;
                
            case 10: // addStyleSheet
                const style = document.createElement('style');
                style.textContent = s1;
                document.head.appendChild(style);
                return 0;
                
            case 11: // reloadWasm
                loadWasm();
                return 0;
                
            case 12: // createThread
                const threadCode = `(${threadTask.toString()})()`;
                const thread = new Worker(URL.createObjectURL(
                    new Blob([threadCode], { type: 'application/javascript' })
                ));
                const threadId = threads.length;
                
                thread.postMessage({ type: 'init', module: wasmModule, threadId: threadId });
                thread.postMessage({ type: 'run', task_id: id });
                
                threads.push(thread);
                return threadId;
                
            case 13: // threadJoin
                if (threads[id]) {
                    threads[id].terminate();
                }
                return 0;
                
            default:
                return 0;
        }
    };
    
    // Console functions
    const log = (fn, msgPtr, msgLen, stylePtr, styleLen) => {
        const msg = getString(msgPtr, msgLen);
        const style = getString(stylePtr, styleLen);
        fn('%c' + msg, style);
    };
    
    const importObject = {
        env: {
            dom_op: dom_op,
            wasm_log: (p,l,s,sl) => log(console.log, p,l,s,sl),
            wasm_warn: (p,l,s,sl) => log(console.warn, p,l,s,sl),
            wasm_err: (p,l,s,sl) => log(console.error, p,l,s,sl),
        }
    };
    
    fetch('./star.wasm')
    .then(response => response.arrayBuffer())
    .then(wasmBytes => WebAssembly.compile(wasmBytes))
    .then(module => {
        wasmModule = module;
        return WebAssembly.instantiate(module, importObject);
    })
    .then(instance => {
        wasmExports = instance.exports;
        elements = [null, document.body];
        threads = [];
        
        if (wasmExports._start) {
            wasmExports._start();
        }
    })
    .catch(error => {
        console.log('Error loading WebAssembly:', error);
    });
}
loadWasm();
</script>
</body>
</html>